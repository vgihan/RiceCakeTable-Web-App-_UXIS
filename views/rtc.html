<html>
<head>
    <meta charset="utf-8" />
    <title>WebRtc tutorial</title>
</head>

<body>
    <div>
        <video id="localVideo" autoplay width="480px" controls></video>
        <video id="remoteVideo" width="480px" autoplay></video>
    </div>
    <!-- <script type="text/javascript" src="https://localhost:3000/views/rtc.js"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.3/socket.io.js" integrity="sha512-2RDFHqfLZW8IhPRvQYmK9bTLfj/hddxGXQAred2wNZGkrKQkLGj8RCkXfRJPHlDerdHHIzTFaahq4s/P4V6Qig==" crossorigin="anonymous"></script>
    <script>
const socket = io.connect('https://localhost', {secure: true});

let localVideo = document.getElementById('localVideo');
let remoteVideo = document.getElementById('remoteVideo');
let localStream;
let remoteStream;
let peerConnection = new RTCPeerConnection(servers);

showRemoteVideo();
peerConnection.onicecandidate = (event) => {
    var message = JSON.stringify({'ice': event.candidate});
    console.log("Send Candidate Message");
    sendMessage(message);
}
peerConnection.ontrack = (stream) => {
    for(const track of stream.getTracks()){
        peerConnection.addTrack(track);
    }
}

var servers = {
    'iceServers': [{
        'urls': 'stun.l.google.com:19302'
    }]
};

navigator.mediaDevices.getUserMedia({
    video: true,
    audio: true
})
.then((stream) => {
    localStream = stream;
    localVideo.srcObject = localStream;
})
.catch((error) => {console.error});

socket.on("serverMessage", readMessage);

function sendMessage(message){
    socket.emit("clientMessage", message);
}

function readMessage(message){
    console.log(message);
    var msg = JSON.parse(message);
    if(msg.ice != undefined){
        peerConnection.addIceCandidate(new RTCIceCandidate(msg.ice));
    }
    else if(msg.sdp.type == "offer"){
        peerConnection.setRemoteDescription(new RTCSessionDescription(msg.sdp))
        .then(() => peerConnection.createAnswer())
        .then((answer) => peerConnection.setLocalDescription(answer))
        .then(() => sendMessage(JSON.stringify({'sdp': peerConnection.localDescription})));
    }
    else if(msg.sdp.type == "answer"){
        peerConnection.setRemoteDescription(new RTCSessionDescription(msg.sdp));
    }
}

function showRemoteVideo() {
    peerConnection.createOffer()
    .then((offer) => peerConnection.setLocalDescription(offer))
    .then(() => sendMessage(JSON.stringify({'sdp': peerConnection.localDescription})));
}
    </script>
</body>

</html>